<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Help Sydney make companies go viral in this fun match-3 puzzle game!">
    <meta name="theme-color" content="#667eea">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>What Will Sydney Make Go Viral Next?</title>
    
    <!-- Performance optimizations -->
    <link rel="dns-prefetch" href="//raw.githubusercontent.com">
    <link rel="preconnect" href="https://raw.githubusercontent.com">
    <link rel="preload" href="styles.css?v=20250101-580000" as="style">
    <link rel="stylesheet" href="styles.css?v=20250101-580000">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="GameEngine.js?v=20250101-210000" as="script">
    <link rel="preload" href="Renderer.js?v=20250101-210000" as="script">
    <link rel="preload" href="TouchHandler.js?v=20250101-210000" as="script">
    
    <!-- Background Music - optimized loading -->
    <audio id="backgroundMusic" preload="metadata" loop>
        <source src="https://github.com/burnpiles/ct-sydney-match/raw/main/media/Catch%20the%20Vibe%20remix%20v2.mp3" type="audio/mpeg">
    </audio>
</head>
<body>
    <div class="start-screen denim-bg" id="startScreen" role="dialog" aria-label="Game start">
        <div class="start-content">
            <div class="tv-hero">
                <div class="tv-frame">
                    <div class="tv-static"></div>
                    <img class="tv-gif" src="https://raw.githubusercontent.com/burnpiles/ct-sydney-match/main/media/general-sydney-small.gif" alt="Sydney in American Eagle Jeans" loading="lazy" />
                </div>
            </div>
                  <div class="game-title-start">üì∫ SYDNEY VISION üì∫</div>
      <div class="headline">
        <span class="headline-main">MATCH 3</span>
        <span class="headline-sub flicker">GO VIRAL</span>
      </div>
            <div class="microcopy">Sydney's Jeans Went Viral<br>Help Her Go Viral Again</div>
            <button class="cta play-btn" onclick="gameManager.startGame()" aria-label="Start game">PLAY GAME</button>
            <div class="or-divider">OR</div>
            <a href="https://contrarianthinking.co/subscribe/?utm_source=contragames&utm_medium=contragames&utm_campaign=contragames&utm_id=contragames" class="cta business-btn" target="_blank" aria-label="Start a real business">START A REAL BUSINESS</a>

        </div>
    </div>
    
    <div class="game-header">
        <div class="header-content">
            <button class="restart-btn" onclick="gameManager.restartGame()" aria-label="Restart game">
                üîÑ
            </button>
            <div class="game-title">SYDNEY VISION</div>
            <button id="soundToggle" class="sound-toggle-btn" onclick="toggleSound()" aria-label="Toggle sound">
                üéµ
            </button>
        </div>
    </div>
    
    <!-- Audio Elements for Sound Effects - optimized with smaller base64 -->
    <audio id="matchSound" preload="none">
        <source src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAAFbgBtbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1t//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjM1AAAAAAAAAAAAAAAAJAYAAAAAAAAABW4A" type="audio/mpeg">
    </audio>
    <audio id="comboSound" preload="none">
        <source src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAAFbgBtbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1t//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjM1AAAAAAAAAAAAAAAAJAYAAAAAAAAABW4A" type="audio/mpeg">
    </audio>

    <audio id="specialSound" preload="none">
        <source src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAAFbgBtbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1t//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjM1AAAAAAAAAAAAAAAAJAYAAAAAAAAABW4A" type="audio/mpeg">
    </audio>

    <div class="game-container">
        <!-- Main content: top row (game + TV) + bottom row (companies) -->
        <div class="main-content">
            <div class="top-row">
                <!-- GIF in retro TV frame -->
                <div class="retro-tv-frame">
                    <div class="tv-inner">
                        <div class="tv-antenna"></div>
                        <div class="tv-screen" onclick="openGifPlayer()" style="cursor: pointer;">
                            <img id="sydneyGif" src="https://raw.githubusercontent.com/burnpiles/ct-sydney-match/main/media/general-sydney-small.gif" alt="Sydney Animation" loading="lazy">
                        </div>
                        <div class="tv-controls">
                            <div class="tv-knob tv-knob-1"></div>
                            <div class="tv-knob tv-knob-2"></div>
                        </div>
                    </div>
                    
                    <!-- Digital TV Channel Display -->
                    <div class="digital-channel-display">
                        <span class="live-indicator">LIVE</span>
                        <span class="channel-number">CH 00</span>
                        <span class="company-name-display" id="channelCompanyName">SYDNEY VISION</span>
                        <span class="company-emoji-display" id="channelCompanyEmoji">üì∫</span>
                    </div>
                </div>
                
                <div class="right-column">
                    <div class="game-board" id="gameBoard" role="grid" aria-label="Game board">
                        <!-- Tiles will be generated by JavaScript -->
                    </div>
                    
                    <!-- AWESOME Match Counter - Green/Black Techno Box - Aligned under game board -->
                    <div class="match-counter-container">
                        <div class="match-counter-header">
                            <span class="counter-title">COMPANIES MATCHED</span>
                            <span class="counter-total" id="total-matches">0/8</span>
                        </div>
                        <div class="match-counter-grid">
                            <div class="match-counter-item" data-company="apple">
                                <div class="counter-emoji">üçé</div>
                                <div class="counter-name">APPLE</div>
                                <div class="counter-count" id="apple-count">0</div>
                            </div>
                            <div class="match-counter-item" data-company="tesla">
                                <div class="counter-emoji">üöô</div>
                                <div class="counter-name">TESLA</div>
                                <div class="counter-count" id="tesla-count">0</div>
                            </div>
                            <div class="match-counter-item" data-company="netflix">
                                <div class="counter-emoji">üé¨</div>
                                <div class="counter-name">NETFLIX</div>
                                <div class="counter-count" id="netflix-count">0</div>
                            </div>
                            <div class="match-counter-item" data-company="starbucks">
                                <div class="counter-emoji">‚òïÔ∏è</div>
                                <div class="counter-name">STARBUCKS</div>
                                <div class="counter-count" id="starbucks-count">0</div>
                            </div>
                            <div class="match-counter-item" data-company="amazon">
                                <div class="counter-emoji">üì¶</div>
                                <div class="counter-name">AMAZON</div>
                                <div class="counter-count" id="amazon-count">0</div>
                            </div>
                            <div class="match-counter-item" data-company="openai">
                                <div class="counter-emoji">ü§ñ</div>
                                <div class="counter-name">OPENAI</div>
                                <div class="counter-count" id="openai-count">0</div>
                            </div>
                            <div class="match-counter-item" data-company="nike">
                                <div class="counter-emoji">üëü</div>
                                <div class="counter-name">NIKE</div>
                                <div class="counter-count" id="nike-count">0</div>
                            </div>
                            <div class="match-counter-item" data-company="spotify">
                                <div class="counter-emoji">üéµ</div>
                                <div class="counter-name">SPOTIFY</div>
                                <div class="counter-count" id="spotify-count">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Desktop Control Buttons - Positioned on the left side of the screen -->
    <div class="desktop-controls">
        <button class="restart-btn" onclick="gameManager.restartGame()" aria-label="Restart game">
            üîÑ
        </button>
        <button id="soundToggle" class="sound-toggle-btn" onclick="toggleSound()" aria-label="Toggle sound">
            üéµ
        </button>
    </div>
    </div>
    
    <div class="completion-screen" id="completionScreen" role="dialog" aria-label="Game completion">
        <!-- Fireworks Container -->
        <div class="fireworks-container">
            <div class="firework" id="firework1"></div>
            <div class="firework" id="firework2"></div>
            <div class="firework" id="firework3"></div>
            <div class="firework" id="firework4"></div>
        </div>
        
        <!-- Animated Background -->
        <div class="completion-background">
            <div class="completion-gif-container">
                <img id="victoryGif" src="https://raw.githubusercontent.com/burnpiles/ct-sydney-match/main/media/general-sydney-small.gif" alt="Sydney Victory Animation" class="completion-gif" loading="lazy">
            </div>
            <div class="completion-overlay"></div>
        </div>
        
        <!-- Main Content -->
        <div class="completion-content">
            <!-- Sydney GIF at the top - full width -->
            <div class="completion-sydney-gif">
                <img src="https://raw.githubusercontent.com/burnpiles/ct-sydney-match/main/media/general-sydney-small.gif" alt="Sydney Victory GIF" class="sydney-victory-gif" loading="lazy">
            </div>
            
            <div class="completion-header">
                <div class="completion-title">üéâ SYDNEY GOES VIRAL üéâ</div>
            </div>
            
            <div class="completion-body">
                <div class="completion-text">
                    <p class="viral-message">BUT... Going Viral Is Not A Real Business Strategy</p>
                    <p class="business-message">Are You Ready To Start An Actual Business?</p>
                </div>
            </div>
            
            <div class="completion-buttons">
                <a href="https://contrarianthinking.co/subscribe/?utm_source=contragames&utm_medium=contragames&utm_campaign=contragames&utm_id=contragames" target="_blank" class="cta-button business-btn" aria-label="Start a business">START A BUSINESS</a>
                <button class="cta-button play-again-btn" onclick="gameManager.playAgain()" aria-label="Play again">PLAY AGAIN</button>
            </div>
            
            <div class="viral-stats-container">
                <p class="viral-stats" id="viralStats"></p>
            </div>
        </div>
    </div>
    
    <!-- Full-screen GIF Player Modal -->
    <div id="gifPlayerModal" class="gif-player-modal" style="display: none;">
        <div class="gif-player-content">
            <button class="gif-player-close" onclick="closeGifPlayer()" aria-label="Close GIF player">‚úï</button>
            <img id="modalGif" src="" alt="Sydney GIF Full Screen" class="modal-gif">
        </div>
    </div>

    <!-- Load JavaScript modules with defer for better performance -->
    <script src="GameEngine.js?v=20250101-630000" defer></script>
    <script src="Renderer.js?v=20250101-570000" defer></script>
    <script src="AnimationManager.js?v=20250101-210000" defer></script>
    <script src="TouchHandler.js?v=20250101-210000" defer></script>
    
    <script>
        // Performance monitoring
        const startTime = performance.now();
        
        // Main game manager class
        class GameManager {
            constructor() {
                this.gameEngine = null;
                this.renderer = null;
                this.animationManager = null;
                this.touchHandler = null;
                this.isInitialized = false;
                this.domCache = new Map(); // Cache DOM elements
                
                this.init();
            }
            
            async init() {
                try {
                    // Cache critical DOM elements
                    this.cacheDOMElements();
                    
                    // Initialize components
                    this.gameEngine = new GameEngine();
                    this.renderer = new Renderer(this.gameEngine);
                    this.animationManager = new AnimationManager();
                    this.touchHandler = new TouchHandler(this.gameEngine);
                    
                    // Set up event listeners
                    this.setupEventListeners();
                    
                    // Set up highlighting listeners after a short delay to ensure DOM is ready
                    setTimeout(() => {
                        if (this.gameEngine) {
                            this.gameEngine.setupHighlightingListeners();
                        }
                    }, 100);
                    
                    // Show start screen instead of immediately starting the game
                    this.showStartScreen();
                    
                    // Start periodic state validation
                    this.startStateValidation();
                    
                    this.isInitialized = true;
                    console.log('Game initialized successfully');
                    
                    // Log performance
                    const initTime = performance.now() - startTime;
                    console.log(`Game initialization took: ${initTime.toFixed(2)}ms`);
                    
                } catch (error) {
                    console.error('Failed to initialize game:', error);
                    this.showError('Failed to load game. Please refresh the page.');
                }
            }

            cacheDOMElements() {
                const elements = [
                    'startScreen', 'completionScreen', 'gameBoard', 'sydneyGif',
                    'soundToggle', 'backgroundMusic', 'total-matches'
                ];
                elements.forEach(id => {
                    this.domCache.set(id, document.getElementById(id));
                });
            }

            startStateValidation() {
                // Check game state every 5 seconds to catch stuck states
                setInterval(() => {
                    if (this.gameEngine && this.isInitialized) {
                        this.gameEngine.validateGameState();
                    }
                }, 5000);
            }

            showCompletionWithViralStats() {
                const mostViral = this.gameEngine.getMostViralCompanies();
                let viralText = '';
                
                if (mostViral.companies.length === 1) {
                    viralText = `P.S. ${mostViral.companies[0].charAt(0).toUpperCase() + mostViral.companies[0].slice(1)} went most viral with ${mostViral.count} matches!`;
                } else {
                    const companyNames = mostViral.companies.map(company => 
                        company.charAt(0).toUpperCase() + company.slice(1)
                    );
                    viralText = `P.S. ${companyNames.join(', ')} went most viral with ${mostViral.count} matches each!`;
                }
                
                // Update the viral stats text
                const viralStatsElement = document.getElementById('viralStats');
                if (viralStatsElement) {
                    viralStatsElement.textContent = viralText;
                }
                
                this.animationManager.showCompletion();
            }

            showStartScreen() {
                const startScreen = this.domCache.get('startScreen');
                if (startScreen) {
                    startScreen.style.display = 'flex';
                }
            }

            startGame() {
                const startScreen = this.domCache.get('startScreen');
                if (startScreen) {
                    startScreen.style.display = 'none';
                }
                
                // Reset animation panel to general GIF
                this.resetAnimationPanel();
                
                // Initialize the game
                this.gameEngine.initGame();
                
                // Ensure highlighting listeners are set up
                setTimeout(() => {
                    if (this.gameEngine) {
                        this.gameEngine.setupHighlightingListeners();
                    }
                }, 200);
            }
            
            resetAnimationPanel() {
                const gif = this.domCache.get('sydneyGif');
                
                if (gif) {
                    gif.src = 'https://raw.githubusercontent.com/burnpiles/ct-sydney-match/main/media/general-sydney-small.gif';
                }
            }
            
            setupEventListeners() {
                console.log('=== GAME MANAGER: Setting up event listeners ===');
                
                // Game engine events - SIMPLIFIED
                this.gameEngine.addEventListener('gravityApplied', (data) => {
                    // Just update the board display
                    if (this.renderer) {
                        this.renderer.updateBoard(data.board);
                    }
                });
                
                this.gameEngine.addEventListener('gameCompleted', () => {
                    this.showCompletionWithViralStats();
                });
                
                // Global event listeners
                window.addEventListener('beforeunload', () => {
                    this.cleanup();
                });
                
                // Handle visibility change for mobile
                document.addEventListener('visibilitychange', () => {
                    // No animations to pause/resume
                });
            }
            
            restartGame() {
                if (!this.isInitialized) return;
                
                try {
                    this.gameEngine.restartGame();
                } catch (error) {
                    console.error('Failed to restart game:', error);
                }
            }
            
            closeAnimation() {
                // Hide the animation overlay
                const overlay = document.getElementById('animationOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
                
                // Reset game state
                if (this.gameEngine) {
                    this.gameEngine.isAnimating = false;
                    this.gameEngine.pendingGravityIndices = null;
                }
            }
            
            closeInlineAnimation() {
                // Hide the inline animation area
                const animationArea = document.getElementById('animationArea');
                if (animationArea) {
                    animationArea.style.display = 'none';
                }
                
                // Reset game state
                if (this.gameEngine) {
                    this.gameEngine.isAnimating = false;
                    this.gameEngine.pendingGravityIndices = null;
                }
                
                // Call the animation manager's close method if available
                if (this.animationManager) {
                    this.animationManager.closeAnimation();
                }
            }
            

            
            playAgain() {
                // Hide completion screen
                const completionScreen = this.domCache.get('completionScreen');
                if (completionScreen) {
                    completionScreen.style.display = 'none';
                }
                
                // Reset animation panel to general GIF
                this.resetAnimationPanel();
                
                // Restart the game
                this.gameEngine.restartGame();
                
                // Ensure highlighting listeners are set up
                setTimeout(() => {
                    if (this.gameEngine) {
                        this.gameEngine.setupHighlightingListeners();
                    }
                }, 200);
            }
            

            
            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(255, 0, 0, 0.9);
                    color: white;
                    padding: 20px;
                    border-radius: 10px;
                    z-index: 10000;
                    text-align: center;
                `;
                errorDiv.textContent = message;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 5000);
            }
            

            
            cleanup() {
                try {
                    if (this.touchHandler) {
                        this.touchHandler.cleanup();
                    }
                } catch (error) {
                    console.error('Error during cleanup:', error);
                }
            }
            
            // Public API for global access
            getGameState() {
                return this.gameEngine ? this.gameEngine.getGameState() : null;
            }
        }
        
        // Initialize game when DOM is ready
        let gameManager;
        
        console.log('=== SCRIPT: Starting game initialization ===');
        console.log('Document ready state:', document.readyState);
        
        if (document.readyState === 'loading') {
            console.log('=== SCRIPT: DOM still loading, adding event listener ===');
            document.addEventListener('DOMContentLoaded', () => {
                console.log('=== SCRIPT: DOMContentLoaded fired ===');
                try {
                    gameManager = new GameManager();
                    console.log('=== SCRIPT: GameManager created successfully ===');
                } catch (error) {
                    console.error('=== SCRIPT: Error creating GameManager ===', error);
                }
            });
        } else {
            console.log('=== SCRIPT: DOM already loaded, creating GameManager immediately ===');
            try {
                gameManager = new GameManager();
                console.log('=== SCRIPT: GameManager created successfully ===');
            } catch (error) {
                console.error('=== SCRIPT: Error creating GameManager ===', error);
            }
        }
        
        // Performance monitoring
        if ('performance' in window) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    const loadTime = perfData.loadEventEnd - perfData.loadEventStart;
                    console.log('Page load time:', loadTime, 'ms');
                    
                    if (loadTime > 1000) {
                        console.warn('Slow page load detected. Consider optimizing resources.');
                    }
                }, 0);
            });
        }
        
        // Performance optimization features
        window.performanceOptimizations = {
            // Disable heavy animations for better performance
            disableHeavyAnimations: function() {
                const style = document.createElement('style');
                style.textContent = `
                    * { animation-duration: 0.1s !important; }
                    .game-title { animation: none !important; }
                    body::before { animation: none !important; }
                `;
                document.head.appendChild(style);
                console.log('Heavy animations disabled for performance');
            },
            
            // Enable performance mode
            enablePerformanceMode: function() {
                this.disableHeavyAnimations();
                // Reduce particle effects
                if (window.gameManager && window.gameManager.animationManager) {
                    window.gameManager.animationManager.maxParticles = 10;
                }
                console.log('Performance mode enabled');
            },
            
            // Monitor frame rate
            monitorFrameRate: function() {
                let frameCount = 0;
                let lastTime = performance.now();
                
                function countFrames() {
                    frameCount++;
                    const currentTime = performance.now();
                    
                    if (currentTime - lastTime >= 1000) {
                        const fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                        console.log('FPS:', fps);
                        
                        if (fps < 30) {
                            console.warn('Low frame rate detected. Consider enabling performance mode.');
                        }
                        
                        frameCount = 0;
                        lastTime = currentTime;
                    }
                    
                    requestAnimationFrame(countFrames);
                }
                
                requestAnimationFrame(countFrames);
            }
        };
        
        // Auto-enable performance mode on slow devices
        if (navigator.hardwareConcurrency && navigator.hardwareConcurrency < 4) {
            setTimeout(() => {
                window.performanceOptimizations.enablePerformanceMode();
            }, 2000);
        }
        
        // Debug function to reset animation state
        window.resetAnimationState = function() {
            if (gameManager && gameManager.gameEngine) {
                gameManager.gameEngine.resetAnimationState();
            }
        };
        
        // Debug function to check game state
        window.checkGameState = function() {
            if (gameManager && gameManager.gameEngine) {
                console.log('Game state:', gameManager.gameEngine.getGameState());
            }
        };

        // Debug function to force reset animation state
        window.resetGameState = function() {
            if (gameManager && gameManager.gameEngine) {
                console.log('=== DEBUG: Force resetting game state ===');
                gameManager.gameEngine.forceResetAnimationState();
                gameManager.gameEngine.validateGameState();
                if (gameManager.renderer) {
                    gameManager.renderer.forceRefreshBoard();
                }
                console.log('Game state reset complete');
            }
        };

        // Emergency recovery function
        window.emergencyRecovery = function() {
            if (gameManager && gameManager.gameEngine) {
                console.log('=== EMERGENCY RECOVERY: Full system reset ===');
                gameManager.gameEngine.forceResetAnimationState();
                gameManager.gameEngine.validateGameState();
                if (gameManager.renderer) {
                    gameManager.renderer.forceRefreshBoard();
                }
                // Force a complete board refresh
                setTimeout(() => {
                    if (gameManager.gameEngine) {
                        gameManager.gameEngine.emit('gravityApplied', { board: [...gameManager.gameEngine.board] });
                    }
                }, 100);
                console.log('Emergency recovery complete');
            }
        };

        // Super aggressive recovery for repeat match issues
        window.fixRepeatMatch = function() {
            if (gameManager && gameManager.gameEngine) {
                console.log('=== REPEAT MATCH FIX: Aggressive recovery ===');
                // Force reset everything
                gameManager.gameEngine.isAnimating = false;
                gameManager.gameEngine.pendingGravityIndices = null;
                gameManager.gameEngine.selectedTile = null;
                
                // Fill any null tiles
                for (let i = 0; i < gameManager.gameEngine.board.length; i++) {
                    if (gameManager.gameEngine.board[i] === null) {
                        gameManager.gameEngine.board[i] = gameManager.gameEngine.companies[Math.floor(Math.random() * gameManager.gameEngine.companies.length)];
                    }
                }
                
                // Force refresh
                if (gameManager.renderer) {
                    gameManager.renderer.forceRefreshBoard();
                }
                
                console.log('Repeat match fix complete');
            }
        };

        // Complete game reset function
        window.resetGame = function() {
            if (gameManager) {
                console.log('=== COMPLETE GAME RESET ===');
                location.reload();
            }
        };
        
        // GIF Player Modal Functions
        window.openGifPlayer = function() {
            const modal = document.getElementById('gifPlayerModal');
            const modalGif = document.getElementById('modalGif');
            const sydneyGif = document.getElementById('sydneyGif');
            
            if (modal && modalGif && sydneyGif) {
                modalGif.src = sydneyGif.src;
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }
        };
        
        window.closeGifPlayer = function() {
            const modal = document.getElementById('gifPlayerModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto'; // Restore scrolling
            }
        };
        
        // Add keyboard support for closing modal
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('gifPlayerModal');
                if (modal && modal.style.display === 'flex') {
                    closeGifPlayer();
                }
            }
        });
        
        // Add click outside to close functionality
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('gifPlayerModal');
            if (modal) {
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        closeGifPlayer();
                    }
                });
            }
        });
        
        // Sound control functions
        let isSoundMuted = false;
        
        window.toggleSound = function() {
            const backgroundMusic = document.getElementById('backgroundMusic');
            const soundToggle = document.getElementById('soundToggle');
            
            if (backgroundMusic && soundToggle) {
                // Add toggle animation
                soundToggle.classList.add('toggling');
                setTimeout(() => {
                    soundToggle.classList.remove('toggling');
                }, 300);
                
                if (isSoundMuted) {
                    // Unmute
                    backgroundMusic.volume = 0.3;
                    soundToggle.textContent = 'üéµ';
                    soundToggle.classList.remove('muted');
                    isSoundMuted = false;
                    
                    // Try to play if not already playing
                    if (backgroundMusic.paused) {
                        backgroundMusic.play().catch(e => console.log('Music failed to play:', e));
                    }
                } else {
                    // Mute
                    backgroundMusic.volume = 0;
                    soundToggle.textContent = 'üîá';
                    soundToggle.classList.add('muted');
                    isSoundMuted = true;
                }
            }
        };
        
        window.setMusicVolume = function(volume) {
            const backgroundMusic = document.getElementById('backgroundMusic');
            if (backgroundMusic) {
                backgroundMusic.volume = Math.max(0, Math.min(1, volume));
                console.log('Music volume set to:', volume);
            }
        };

        // Accordion toggle function for new start screen
        document.addEventListener('DOMContentLoaded', function() {
            // TV Channel Sound Effect
            const tvGif = document.querySelector('.tv-gif');
            const backgroundMusic = document.getElementById('backgroundMusic');
            
            if (tvGif) {
                // Play TV channel sound after 1 second using Web Audio API
                setTimeout(() => {
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        // TV channel surfing sound
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
                        oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.2);
                        oscillator.type = 'sawtooth';
                        
                        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.3);
                        
                        console.log('TV channel sound played');
                    } catch (e) {
                        console.log('TV sound failed to play:', e);
                    }
                }, 1000);
                
                // Ensure GIF stays visible after animation completes
                setTimeout(() => {
                    tvGif.style.opacity = '1';
                    tvGif.style.visibility = 'visible';
                    tvGif.style.filter = 'brightness(1) blur(0)';
                    console.log('TV GIF made permanently visible');
                }, 2100); // Slightly after animation ends
            }
            
            // Start ambient background music after TV sound
            if (backgroundMusic) {
                setTimeout(() => {
                    backgroundMusic.volume = 0.3; // Low volume
                    backgroundMusic.play().catch(e => console.log('Background music failed to play:', e));
                    
                    // Initialize sound toggle state
                    const soundToggle = document.getElementById('soundToggle');
                    if (soundToggle) {
                        soundToggle.textContent = 'üéµ';
                        soundToggle.classList.remove('muted');
                        isSoundMuted = false;
                    }
                }, 2000);
            }
            

        });


    </script>
</body>
</html>